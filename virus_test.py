import pefile
import numpy, scipy, os, array
import binascii
from scipy.misc import imsave

def fileExtract(filePath):
	try:
		pe = pefile.PE(filePath)
		for section in pe.sections:
			if('.rsrc' in section.Name):
				rsrPointer = section.PointerToRawData
				rsrSize = section.SizeOfRawData
		return rsrPointer, rsrSize
	except Exception, e:
		print Exception, ':', e, '', filePath
		return False, False

def generateImage(fn):

	fileName = fn
	f = open(fileName,'rb')
	start_size = fileExtract(fileName)
	start = start_size[0]
	size = start_size[1]
	ln = os.path.getsize(fileName)
	#ln = os.path.getsize(filename) # length of file in bytes
	width = 64
	rem = ln % width
	content = array.array("B")
	content.fromfile(f, ln - rem)
	f.close()
	hexst = binascii.hexlify(content)

	#print(type(hexst))
	fh = numpy.array([int(hexst[i:i+2],16) for i in range(start, start + size, 2)])
	#print (len(fh))

	rn = len(fh)//width
	#print(type(fh))
	#fh = numpy.reshape(fh[:rn*width],(-1,width))
	fh = fh.reshape(-1, width)
	#print (fh[1][22])
	#print (fh[1])
	fh = numpy.uint8(fh)
	str = fileName.strip('.exe') + '.png'
	scipy.misc.imsave(str, fh) # save the image
	
#if __name__ == '__main__':
#	main()	
